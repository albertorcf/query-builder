// app/src/components/query-builder/action/ActionBuilder.tsx
"use client";
import { useState, useEffect, useMemo } from 'react'
import type { JsonGroup, Config, ImmutableTree, BuilderProps } from '@react-awesome-query-builder/antd'; // for TS example
import { Query, Builder, Utils as QbUtils } from '@react-awesome-query-builder/antd';
import { AntdConfig, AntdWidgets } from '@react-awesome-query-builder/antd';

import '@react-awesome-query-builder/antd/css/styles.css';
import '../MyQueryBuilder.css';
import './ActionBuilder.css';

// ‚öõÔ∏è Tipagem das propriedades do componente
type MyQueryBuilderProps = {
  config: Config;
  onTreeChange: (tree: ImmutableTree) => void;
  initialTree?: ImmutableTree | null;
};

// ============================================================================
// ‚ú® Componente ActionBuilder
// ============================================================================
export default function ActionBuilder(props: MyQueryBuilderProps) {
  const { config, onTreeChange, initialTree } = props;
  const [tree, setTree] = useState<ImmutableTree | null>(initialTree ?? null);
  const [isClient, setIsClient] = useState(false);

  // üîß Configura√ß√£o espec√≠fica para Actions - usando useMemo para otimiza√ß√£o
  // O actionConfig √© criado usando useMemo para evitar recria√ß√µes desnecess√°rias do objeto config a cada render
  const actionConfig = useMemo(() => {
    return {
      ...config,
      settings: {
        ...AntdConfig.settings,
        showNot: false, // Esconde bot√£o Not
        addRuleLabel: 'Add action', // Muda texto do bot√£o Add rule
      },
    };
  }, [config]);

  // üîÑ Efeito para inicializar a √°rvore de consulta quando o componente √© montado no cliente
  // ou quando a configura√ß√£o (config) ou initialTree √© alterada.
  useEffect(() => {
    setIsClient(true);
    if (initialTree) {
      setTree(initialTree);
    } else {
      const { fixedTree } = QbUtils.Validation.sanitizeTree(
        QbUtils.loadTree({ id: QbUtils.uuid(), type: 'group' }),
        actionConfig
      );
      setTree(fixedTree);
    }
  }, [actionConfig, initialTree]);  // Depende de actionConfig ao inv√©s de config

  // üîÑ Fun√ß√£o de callback para quando a √°rvore de consulta √© alterada
  const onChange = (immutableTree: ImmutableTree, config: Config) => {
    setTree(immutableTree);
    onTreeChange(immutableTree);
    // Opcional: logar a string de consulta para depura√ß√£o
    console.log(QbUtils.queryString(immutableTree, config));
  };

  // ‚è≥ Exibe um loader enquanto o componente n√£o est√° montado no cliente ou a √°rvore n√£o foi inicializada
  if (!isClient || !tree) {
    return <div>Loading Query Builder...</div>;
  }

  // üé® Renderiza√ß√£o do construtor de consultas
  return (
    <div>
      <Query
        {...actionConfig}
        value={tree}
        onChange={onChange}
        renderBuilder={(props) => (
          <div className="query-builder">
            <Builder {...props} />
          </div>
        )}
      />
    </div>
  );
}
